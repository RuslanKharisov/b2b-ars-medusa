name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.backend.outputs.changed }}
      frontend_changed: ${{ steps.frontend.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect backend changes
        id: backend
        run: |
          if git diff --name-only HEAD^ HEAD | grep -i "^ars-backend/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect frontend changes
        id: frontend
        run: |
          if git diff --name-only HEAD^ HEAD | grep "^ars-storefront/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH access
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Rsync project to VPS
        run: |
          rsync -az \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{secrets.SERVER_USER}}@${{secrets.REMOTE_HOST}}:/home/${{secrets.SERVER_USER}}/b2b-ars-medusa

      - name: Deploy & start backend/frontend via PM2
        run: |
          ssh -o StrictHostKeyChecking=no ${{secrets.SERVER_USER}}@${{secrets.REMOTE_HOST}} << 'EOF'
          set -e

          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ NVM
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

          # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Node.js
          nvm use 22.13.1 

          cd /home/${{ secrets.SERVER_USER }}/b2b-ars-medusa

          echo "ðŸ“¦ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ñ„Ð°Ð¹Ð»Ñ‹..."
          cp /home/${{ secrets.SERVER_USER }}/secrets/env-backend ars-backend/.env
          cp /home/${{ secrets.SERVER_USER }}/secrets/env-storefront ars-storefront/.env

          if [[ "${{ needs.detect-changes.outputs.backend_changed }}" == "true" ]]; then
            echo "ðŸ”§ Backend Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½. Ð‘Ð¸Ð»Ð´Ð¸Ð¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Medusa..."

            cd ars-backend/
            npm install
            npm run build

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env Ð¸ package.json  Ð² .medusa/server
            cp .env .medusa/server/.env
            # cp package.json ../.medusa/server/package.json

            cd .medusa/server
            npm install

            echo "ðŸš€ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Medusa admin Ð¸ worker Ñ‡ÐµÑ€ÐµÐ· PM2"

            pm2 restart medusa-admin --update-env
            pm2 restart medusa-worker --update-env

            # ToDo: Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ, ÐµÑÐ»Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ° Ð½ÐµÑ‚, ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ!!!
            # pm2 start npm --name medusa-admin -- run start:admin
            # pm2 start npm --name medusa-worker -- run start:worker
          else
            echo "âœ… Backend Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿ÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÑƒ"
          fi

          if [[ "${{ needs.detect-changes.outputs.frontend_changed }}" == "true" ]]; then
            echo "ðŸŒ Frontend Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Storefront..."

            cd /home/${{ secrets.SERVER_USER }}/b2b-ars-medusa/ars-storefront
            yarn install
            yarn build

            if pm2 list | grep -q storefront; then
              echo "â™»ï¸ PM2: storefront ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ â€” Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº..."
              pm2 restart storefront --update-env
            else
              echo "ðŸš€ PM2: storefront Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº..."
              pm2 start yarn --name storefront -- start
            fi
          else
            echo "âœ… Frontend Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
          fi

          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
          EOF
